generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Clinica {
  id         String      @id @default(cuid())
  nombre     String
  direccion  String
  logoUrl    String?
  activa     Boolean     @default(true)
  createdAt  DateTime    @default(now())
  atenciones Atencion[]
  plantillas Plantilla[]
  eventosQuirurgicos EventoQuirurgico[]
}

model Paciente {
  id             String     @id @default(cuid())
  nombreCompleto String
  rut            String     @unique
  fechaNac       DateTime?
  prevision      String
  isapreNombre   String?
  antecedentes   String?
  createdAt      DateTime   @default(now())
  atenciones     Atencion[]
  eventosQuirurgicos EventoQuirurgico[]
}

model Atencion {
  id           String      @id @default(cuid())
  pacienteId   String
  clinicaId    String
  fecha        DateTime    @default(now())
  diagnostico  String
  tratamiento  String?
  indicaciones String?
  createdAt    DateTime    @default(now())
  paciente     Paciente    @relation(fields: [pacienteId], references: [id])
  clinica      Clinica     @relation(fields: [clinicaId], references: [id])
  documentos   Documento[]

  @@index([pacienteId])
  @@index([clinicaId])
}

model Plantilla {
  id          String      @id @default(cuid())
  nombre      String
  tipo        String
  pdfUrl      String
  mapeoCampos String
  activa      Boolean     @default(true)
  previsionNombre String?
  clinicaId   String?
  clinica     Clinica?    @relation(fields: [clinicaId], references: [id])
  documentos  Documento[]

  @@index([clinicaId])
  @@index([tipo])
  @@index([previsionNombre])
}

model Documento {
  id             String    @id @default(cuid())
  atencionId     String?
  eventoQuirurgicoId String?
  plantillaId    String
  pdfGeneradoUrl String?
  createdAt      DateTime  @default(now())
  atencion       Atencion?  @relation(fields: [atencionId], references: [id])
  eventoQuirurgico EventoQuirurgico? @relation(fields: [eventoQuirurgicoId], references: [id])
  plantilla      Plantilla @relation(fields: [plantillaId], references: [id])

  @@index([atencionId])
  @@index([eventoQuirurgicoId])
  @@index([plantillaId])
}

model EquipoMedico {
  id        String   @id @default(cuid())
  nombre    String
  rut       String
  rol       String
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  eventosComoCirujano   EventoQuirurgico[] @relation("EventoCirujano")
  eventosComoAnestesista EventoQuirurgico[] @relation("EventoAnestesista")
  eventosComoArsenalera  EventoQuirurgico[] @relation("EventoArsenalera")
  eventosComoAyudante1   EventoQuirurgico[] @relation("EventoAyudante1")
  eventosComoAyudante2   EventoQuirurgico[] @relation("EventoAyudante2")

  @@index([rol])
}

model Procedimiento {
  id          String   @id @default(cuid())
  codigoFonasa String
  descripcion String
  tipo        String?
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now())
  eventos     EventoQuirurgico[]

  @@index([codigoFonasa])
}

model EventoQuirurgico {
  id                String   @id @default(cuid())
  pacienteId        String
  clinicaId         String
  fechaCirugia      DateTime
  diagnostico       String
  codigoCie10       String?
  procedimientoId   String?
  lateralidad       String?
  alergiaLatex      Boolean  @default(false)
  requiereBiopsia   Boolean  @default(false)
  requiereRayos     Boolean  @default(false)
  cirujanoId        String?
  anestesistaId     String?
  arsenaleraId      String?
  ayudante1Id       String?
  ayudante2Id       String?
  riesgosDescripcion String?
  createdAt         DateTime @default(now())
  paciente          Paciente @relation(fields: [pacienteId], references: [id])
  clinica           Clinica  @relation(fields: [clinicaId], references: [id])
  procedimiento     Procedimiento? @relation(fields: [procedimientoId], references: [id])
  cirujano          EquipoMedico? @relation("EventoCirujano", fields: [cirujanoId], references: [id])
  anestesista       EquipoMedico? @relation("EventoAnestesista", fields: [anestesistaId], references: [id])
  arsenalera        EquipoMedico? @relation("EventoArsenalera", fields: [arsenaleraId], references: [id])
  ayudante1         EquipoMedico? @relation("EventoAyudante1", fields: [ayudante1Id], references: [id])
  ayudante2         EquipoMedico? @relation("EventoAyudante2", fields: [ayudante2Id], references: [id])
  documentos        Documento[]

  @@index([pacienteId])
  @@index([clinicaId])
}
